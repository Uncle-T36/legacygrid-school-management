{% extends 'billing/base.html' %}

{% block title %}Backup Management - LegacyGrid{% endblock %}

{% block content %}
<h2>📦 Backup Management (Owner Only)</h2>

{% if demo_mode %}
<div class="alert alert-warning">
    <strong>⚠️ Demo Mode Active:</strong> Backup operations are simulated for testing only.
</div>
{% endif %}

<div class="alert alert-info">
    <strong>🔒 Owner Access:</strong> You are managing critical backup operations as the system owner (Uncle-T36).
</div>

<!-- Create New Backup Form -->
<div style="margin-bottom: 30px; padding: 20px; border: 1px solid #28a745; border-radius: 8px; background: #d4edda;">
    <h3>➕ Create New Backup</h3>
    <form method="post" style="margin-top: 15px;">
        {% csrf_token %}
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: end;">
            <div>
                <label for="backup_name" style="display: block; margin-bottom: 5px; font-weight: bold;">Backup Name:</label>
                <input type="text" id="backup_name" name="backup_name" 
                       placeholder="Auto-generated if empty" 
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div>
                <label for="backup_type" style="display: block; margin-bottom: 5px; font-weight: bold;">Backup Type:</label>
                <select id="backup_type" name="backup_type" 
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="full">Full Backup (Complete System)</option>
                    <option value="incremental">Incremental (Changes Only)</option>
                    <option value="differential">Differential (Since Last Full)</option>
                </select>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <button type="submit" class="btn btn-success">🚀 Start Backup</button>
            <button type="button" id="schedule-backup-btn" class="btn btn-info">⏰ Schedule Backup</button>
        </div>
    </form>
</div>

<!-- Backup History -->
<div>
    <h3>📋 Backup History</h3>
    {% if backups %}
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead style="background: #f8f9fa;">
                <tr>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Name</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Type</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Status</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Created</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Completed</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Size</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Checksum</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for backup in backups %}
                <tr>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                        <strong>{{ backup.name }}</strong>
                        {% if backup.error_message %}
                        <br><small style="color: #dc3545;">{{ backup.error_message|truncatechars:50 }}</small>
                        {% endif %}
                    </td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                        <span style="padding: 4px 8px; border-radius: 4px; background: #e9ecef; font-size: 12px;">
                            {{ backup.get_backup_type_display }}
                        </span>
                    </td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                        {% if backup.status == 'completed' %}
                            <span style="color: #28a745; font-weight: bold;">✅ {{ backup.get_status_display }}</span>
                        {% elif backup.status == 'failed' %}
                            <span style="color: #dc3545; font-weight: bold;">❌ {{ backup.get_status_display }}</span>
                        {% elif backup.status == 'in_progress' %}
                            <span style="color: #ffc107; font-weight: bold;">⏳ {{ backup.get_status_display }}</span>
                        {% else %}
                            <span style="color: #6c757d; font-weight: bold;">⏸️ {{ backup.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td style="padding: 12px; border: 1px solid #ddd;">{{ backup.created_at|date:"M d, Y H:i" }}</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                        {% if backup.completed_at %}
                            {{ backup.completed_at|date:"M d, Y H:i" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                        {% if backup.file_size %}
                            {{ backup.file_size|filesizeformat }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                        {% if backup.checksum %}
                            <code style="font-size: 10px;">{{ backup.checksum|truncatechars:12 }}</code>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                        {% if backup.status == 'completed' %}
                            <button class="btn btn-sm btn-primary restore-btn" data-backup-id="{{ backup.id }}">🔄 Restore</button>
                            <button class="btn btn-sm btn-info download-btn" data-backup-id="{{ backup.id }}">📥 Download</button>
                        {% elif backup.status == 'in_progress' %}
                            <button class="btn btn-sm btn-warning cancel-btn" data-backup-id="{{ backup.id }}">⏹️ Cancel</button>
                        {% elif backup.status == 'failed' %}
                            <button class="btn btn-sm btn-secondary retry-btn" data-backup-id="{{ backup.id }}">🔄 Retry</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa; text-align: center;">
        <p style="margin: 0;">No backups created yet.</p>
        <p style="margin: 10px 0 0 0; font-size: 14px; color: #666;">
            Create your first backup using the form above to ensure data protection.
        </p>
    </div>
    {% endif %}
</div>

<!-- Backup Configuration -->
<div style="margin-top: 30px; padding: 20px; border: 1px solid #007bff; border-radius: 8px; background: #f8f9fa;">
    <h3>⚙️ Backup Configuration</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
        <div>
            <h4>📅 Scheduled Backups</h4>
            <ul style="list-style-type: none; padding: 0;">
                <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                    <strong>Daily Full Backup:</strong> 
                    <span style="color: #28a745;">✅ Enabled</span> (2:00 AM UTC)
                </li>
                <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                    <strong>Hourly Incremental:</strong> 
                    <span style="color: #28a745;">✅ Enabled</span>
                </li>
                <li style="padding: 8px 0;">
                    <strong>Weekly Archive:</strong> 
                    <span style="color: #ffc107;">⏸️ Disabled</span>
                </li>
            </ul>
            <button class="btn btn-primary btn-sm">⚙️ Configure Schedule</button>
        </div>
        
        <div>
            <h4>💾 Storage Configuration</h4>
            <ul style="list-style-type: none; padding: 0;">
                <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                    <strong>Primary Storage:</strong> Local (500GB available)
                </li>
                <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                    <strong>Cloud Backup:</strong> AWS S3 (Enabled)
                </li>
                <li style="padding: 8px 0;">
                    <strong>Retention Policy:</strong> 30 days
                </li>
            </ul>
            <button class="btn btn-info btn-sm">🗃️ Storage Settings</button>
        </div>
    </div>
</div>

<!-- Best Practices -->
<div style="margin-top: 30px; padding: 20px; border: 1px solid #17a2b8; border-radius: 8px; background: #d1ecf1;">
    <h3>💡 Backup Best Practices</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
        <div>
            <h4>🔄 Regular Backups</h4>
            <ul>
                <li>Schedule daily full backups during low-traffic hours</li>
                <li>Enable incremental backups every hour</li>
                <li>Test restore procedures monthly</li>
                <li>Monitor backup completion and file integrity</li>
            </ul>
        </div>
        <div>
            <h4>🛡️ Security Measures</h4>
            <ul>
                <li>Encrypt all backup files with strong passwords</li>
                <li>Store backups in multiple geographic locations</li>
                <li>Verify checksums before and after transfers</li>
                <li>Limit backup access to authorized personnel only</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Schedule Backup Button
    document.getElementById('schedule-backup-btn').addEventListener('click', function() {
        alert('📅 Backup Scheduling\n\n' +
              'This feature allows you to schedule automated backups.\n' +
              'Configure recurring backups in the settings panel.');
    });
    
    // Restore Buttons
    document.querySelectorAll('.restore-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const backupId = this.dataset.backupId;
            if (confirm('⚠️ Restore Confirmation\n\nThis will restore the system to the selected backup state.\nAll current data will be replaced.\n\nAre you sure you want to continue?')) {
                {% if demo_mode %}
                alert('🔄 Demo Mode: Restore operation simulated.\n\nIn production, this would restore the system from the selected backup.');
                {% else %}
                // In production, trigger actual restore
                window.location.href = `/disaster-recovery/restore/${backupId}/`;
                {% endif %}
            }
        });
    });
    
    // Download Buttons
    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const backupId = this.dataset.backupId;
            {% if demo_mode %}
            alert('📥 Demo Mode: Download feature available in production mode.');
            {% else %}
            window.location.href = `/disaster-recovery/download/${backupId}/`;
            {% endif %}
        });
    });
    
    // Cancel Buttons
    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const backupId = this.dataset.backupId;
            if (confirm('Cancel this backup operation?')) {
                // AJAX call to cancel backup
                alert('⏹️ Backup cancelled successfully.');
                location.reload();
            }
        });
    });
    
    // Retry Buttons
    document.querySelectorAll('.retry-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const backupId = this.dataset.backupId;
            if (confirm('Retry this failed backup operation?')) {
                alert('🔄 Backup retry initiated.');
                location.reload();
            }
        });
    });
});
</script>
{% endblock %}